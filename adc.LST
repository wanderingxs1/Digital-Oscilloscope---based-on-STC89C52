C51 COMPILER V9.00   ADC                                                                   04/12/2023 20:35:58 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE ADC
OBJECT MODULE PLACED IN adc.OBJ
COMPILER INVOKED BY: D:\keil4\C51\BIN\C51.EXE adc.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include<adc.h>
   2          
   3          extern char ADC_RESULT;
   4          extern char DAC_VALUE;
   5          extern char workMode;
   6          extern char WAVE_VALUE;
   7          extern char OUTPUT_VALUE;
   8          
   9          unsigned int channalSelect=0x0000;//DAC通道选择
  10          
  11          void adc_init()
  12          {
  13   1          P1ASF=0x08;     //确定p13是a-d功能,输入
  14   1              //开AD电源，速度设置最慢，清零一次AD开始位和AD完成位，选择P1^3作为AD输入端口
  15   1          ADC_CONTR=ADC_INIT;
  16   1          delay(2);
  17   1      }
  18          
  19          
  20          
  21          void ad_start()         //adc放在定时器中断里边，采样频率为4000Hz。
  22          {
  23   1              //启动一次AD转换，然后等待转换结束。ADC中断是低优先级
  24   1              ADC_CONTR=ADC_START;
  25   1      
  26   1              //这段时间刚好用来做DAC,把DA结果输出
  27   1          switch(workMode){
  28   2              case 1:
  29   2                      channalSelect=CH1;
  30   2              dac_work(channalSelect,DAC_VALUE);
  31   2                      channalSelect=CH2;
  32   2              dac_work(channalSelect,WAVE_VALUE);
  33   2              break;
  34   2              case 2:
  35   2                      channalSelect=CH1;
  36   2              dac_work(channalSelect,DAC_VALUE);
  37   2                      channalSelect=CH2;
  38   2              dac_work(channalSelect,OUTPUT_VALUE);
  39   2              break;
  40   2              case 3:
  41   2                      channalSelect=CH1;
  42   2              dac_work(channalSelect,DAC_VALUE);
  43   2                      channalSelect=CH2;
  44   2              dac_work(channalSelect,0x00);
  45   2              break;
  46   2              default:break;
  47   2          }
  48   1      
  49   1      
  50   1      }
  51          
  52          
  53          void dac_work(int channalSelect,char value){
  54   1              XBYTE[channalSelect]=value;     
  55   1      }
C51 COMPILER V9.00   ADC                                                                   04/12/2023 20:35:58 PAGE 2   

  56          
  57          void adc_work() interrupt 5
  58          {
  59   1              //ADC_START转换结束后自动置0
  60   1              //ADC_FLAG转换结束后为1,需要手动清零
  61   1              ADC_CONTR=ADC_INIT;
  62   1      
  63   1              //把AD结果存储
  64   1              //问题:ADC转换值是1024个阶,DAC转换值是256个阶,要进行转换,舍去最低两位
  65   1              ADC_RESULT=ADC_RES;
  66   1      
  67   1              //工作模式1实时输出AD结果,并储存(在main.c里)
  68   1              //工作模式2实时输出结果
  69   1              switch(workMode){
  70   2              case 1:DAC_VALUE=ADC_RESULT;break;
  71   2              case 2:DAC_VALUE=ADC_RESULT;break;
  72   2              default:break;
  73   2              }
  74   1      
  75   1              ADC_RES=0;
  76   1      }
  77          
  78          void delay(int delayTime)
  79          {
  80   1              unsigned int x;
  81   1              while(delayTime--){
  82   2              x=5000;
  83   2              while(x--);
  84   2              }
  85   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    146    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
